{% extends 'base.html' %}

{% block title %}{{ task.title }}{% endblock %}

{% block content %}
    <div class="row">
        <div class="col-lg-8">
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-info text-white">
                    <span class="badge bg-secondary me-2">{{ task.get_status_display }}</span>
                    <span class="badge bg-warning text-dark">ğŸ’° {{ task.reward_points }} P</span>
                </div>
                <div class="card-body">
                    <h1 class="card-title">{{ task.title }}</h1>
                    <p class="text-muted">ë“±ë¡ì: {{ task.registrant.username }} | ë“±ë¡ì¼: {{ task.created_at|date:"Y.m.d H:i" }}</p>
                    <hr>
                    <p class="card-text">{{ task.content|linebreaksbr }}</p>
                </div>
                <ul class="list-group list-group-flush">
                    <li class="list-group-item">ğŸ“ **ì¥ì†Œ:** {{ task.location }}</li>
                    <li class="list-group-item">â³ **ë§ˆê° ê¸°í•œ:** <strong class="text-danger">{{ task.due_date|date:"Yë…„ mì›” dì¼ Hì‹œ ië¶„" }}</strong></li>
                    {% if task.assigned_to %}
                        <li class="list-group-item bg-light">âœ… **í• ë‹¹ëœ ë„ìš°ë¯¸:** <strong>{{ task.assigned_to.username }}</strong></li>
                    {% endif %}
                </ul>
                
                {% if task.status == 'completed' and task.review %}
                <div class="card-footer bg-success text-white">
                    <p class="mb-1">â­ï¸ **ì‘ì„±ëœ ë¦¬ë·°:** {{ task.review.rating }}ì  / 5ì </p>
                    <p class="mb-0 small">"{{ task.review.comment|default:"ë¦¬ë·° ë‚´ìš© ì—†ìŒ"|truncatechars:50 }}"</p>
                </div>
                {% endif %}
                </div>

            <div class="text-center mb-5 p-4 border rounded">
                {% if user.is_authenticated %}
                    
                    {% if is_registrant %}
                        <p class="lead text-primary">ğŸ“¢ **ì´ ì‹¬ë¶€ë¦„ì€ íšŒì›ë‹˜ê»˜ì„œ ë“±ë¡í•˜ì‹  ê³µê³ ì…ë‹ˆë‹¤.**</p>
                        
                        {% if task.status == 'assigned' %}
                            <form method="post" action="{% url 'task_complete' pk=task.pk %}">
                                {% csrf_token %}
                                <button type="submit" class="btn btn-warning btn-lg">âœ… ì‹¬ë¶€ë¦„ ì™„ë£Œ ì²˜ë¦¬ ë° í¬ì¸íŠ¸ ì§€ê¸‰</button>
                            </form>
                        
                        {% elif task.status == 'completed' %}
                            <p class="text-success lead">ì´ ì‹¬ë¶€ë¦„ì€ **ì™„ë£Œ ì²˜ë¦¬**ë˜ì—ˆìŠµë‹ˆë‹¤. ê°ì‚¬í•©ë‹ˆë‹¤!</p>
                            
                            {% if review_possible %}
                                <a href="{% url 'task_review' pk=task.pk %}" class="btn btn-danger btn-lg mt-3">â­ï¸ **ë„ìš°ë¯¸ í‰ê°€ (ë¦¬ë·°) ì‘ì„±í•˜ê¸°**</a>
                            {% endif %}
                            {% elif task.status == 'open' %}
                            <p>ì•„ë˜ ì§€ì›ì ëª©ë¡ì—ì„œ ë„ìš°ë¯¸ë¥¼ ì„ íƒí•˜ì—¬ í• ë‹¹í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. (í˜„ì¬ MVPì—ì„œëŠ” ìˆ˜ë™ìœ¼ë¡œ ê´€ë¦¬ì í˜ì´ì§€ì—ì„œ í• ë‹¹ ê°€ëŠ¥)</p>
                        {% endif %}

                    {% elif task.status == 'open' %}
                        {% if has_applied %}
                            <button class="btn btn-warning btn-lg" disabled>ì´ë¯¸ ì§€ì› ì™„ë£Œ (ëŒ€ê¸° ì¤‘)</button>
                        {% else %}
                            <a href="{% url 'task_apply' pk=task.pk %}" class="btn btn-success btn-lg">âœ¨ ì‹¬ë¶€ë¦„ ì§€ì›í•˜ê¸° ({{ task.reward_points }} P ë³´ìƒ)</a>
                        {% endif %}
                        
                    {% elif task.status != 'open' %}
                        <button class="btn btn-danger btn-lg" disabled>ğŸš« í˜„ì¬ ì§€ì› ë¶ˆê°€ëŠ¥ ìƒíƒœì…ë‹ˆë‹¤.</button>
                    {% endif %}
                    
                {% else %}
                    <p class="lead">ì‹¬ë¶€ë¦„ì— ì§€ì›í•˜ë ¤ë©´ <a href="{% url 'login' %}">ë¡œê·¸ì¸</a>ì´ í•„ìš”í•©ë‹ˆë‹¤.</p>
                {% endif %}
            </div>
            
        </div>
        
        <div class="col-lg-4">
            {% if is_registrant %}
            <div class="card bg-light shadow-sm">
                <div class="card-header h4">ğŸ§‘â€ğŸ’» ì§€ì›ì ëª©ë¡ ({{ applications.count }}ëª…)</div>
                <ul class="list-group list-group-flush">
                    {% for app in applications %}
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            {{ app.applicant.username }}
                            {% if app.status == 'pending' %}
                                <span class="badge bg-primary">ëŒ€ê¸° ì¤‘</span>
                            {% elif app.status == 'accepted' %}
                                <span class="badge bg-success">ìˆ˜ë½ë¨</span>
                            {% endif %}
                            </li>
                    {% empty %}
                        <li class="list-group-item text-center text-muted">ì•„ì§ ì§€ì›ìê°€ ì—†ìŠµë‹ˆë‹¤.</li>
                    {% endfor %}
                </ul>
            </div>
            {% endif %}
        </div>
    </div>
{% endblock %}